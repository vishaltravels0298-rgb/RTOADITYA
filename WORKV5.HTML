<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>Vehicle Manager</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  body{
    font-family: Arial, sans-serif; margin:0; padding:0;
    text-align:center; background:linear-gradient(135deg,#d0e8ff,#f0f8ff);
  }
  .container{ padding:15px; max-width:480px; margin:auto; }
  h1{ font-size:20px; margin-bottom:15px; color:#004080; }
  .btn{
    display:block; width:85%; margin:8px auto; padding:10px; font-size:14px;
    background:#007bff; color:#fff; border:none; border-radius:25px;
    box-shadow:0 3px 6px rgba(0,0,0,.2); transition:.2s;
  }
  .btn:hover{ background:#0056b3; transform:scale(1.02); }
  .btn-secondary{ background:#6c757d; }
  .btn-warning{ background:#ff9800; }
  .btn-danger{ background:#dc3545; }
  input, label{
    width:85%; text-align:left; display:block; margin:5px auto;
  }
  input{
    padding:8px; border:1px solid #ccc; border-radius:8px; font-size:14px;
  }
  table{ width:100%; border-collapse:collapse; margin-top:10px; font-size:12px; background:#fff; border-radius:8px; overflow:hidden; }
  th,td{ border:1px solid #ddd; padding:6px; vertical-align:top; }
  th{ background:#007bff; color:#fff; font-size:12px; position:sticky; top:0; }
  .expired{ background:#ffcccc; }
  .actions a,.actions button{
    font-size:11px; padding:5px 8px; border:none; border-radius:6px; margin:2px; cursor:pointer;
  }
  .wa{ background:#25D366; color:#fff; text-decoration:none; display:inline-block; }
  .upd{ background:#ff9800; color:#fff; }
  .footer{ margin-top:15px; font-size:11px; color:#555; }
  .row-muted{ color:#555; font-size:11px; }
</style>
</head>
<body>

<!-- Home -->
<div class="container" id="homeScreen">
  <h1>üöç Vehicle Manager</h1>
  <button class="btn" onclick="showScreen('searchScreen')">üîç Search</button>
  <button class="btn" onclick="startNew()">‚ûï Add New Vehicle</button>
  <button class="btn" onclick="showThisMonthExpiry()">üìÖ This Month Expiry</button>
  <div class="footer">Developed by @Aditya Vadode</div>
</div>

<!-- Add / Edit -->
<div class="container" id="addScreen" style="display:none;">
  <h1 id="addTitle">Add Vehicle Detail</h1>

  <label>Vehicle No</label>
  <input type="text" id="vehicleNo" placeholder="e.g. GJ-05-AB-1234">

  <label>Owner Name</label>
  <input type="text" id="owner" placeholder="Owner Name">

  <label>Owner Mobile Number</label>
  <input type="tel" id="ownerMobile" placeholder="91XXXXXXXXXX">

  <label>Chassis No</label>
  <input type="text" id="chassisNo" placeholder="Chassis No">

  <label>Engine No</label>
  <input type="text" id="engineNo" placeholder="Engine No">

  <label>Make</label>
  <input type="text" id="make" placeholder="Make / Model">

  <label>Slipper Capacity</label>
  <input type="text" id="slipperCapacity" placeholder="Slipper Capacity">

  <label>Permit Date</label>
  <input type="date" id="permitDate">

  <label>Insurance Expiry</label>
  <input type="date" id="insuranceDate">

  <label>Fitness Expiry</label>
  <input type="date" id="fitnessDate">

  <label>Authorization Expiry</label>
  <input type="date" id="authorizationDate">

  <label>Home Tax Expiry</label>
  <input type="date" id="homeTaxDate">

  <button class="btn" onclick="saveVehicle()">üíæ Save</button>
  <button class="btn btn-secondary" onclick="showScreen('homeScreen')">‚¨Ö Back</button>
</div>

<!-- Search -->
<div class="container" id="searchScreen" style="display:none;">
  <h1>Search Vehicle</h1>
  <input type="text" id="searchInput" placeholder="Enter Vehicle No or Owner Name" oninput="searchVehicle()">
  <div id="searchResults"></div>
  <button class="btn btn-secondary" onclick="showScreen('homeScreen')">‚¨Ö Back</button>
</div>

<!-- This Month Expiry -->
<div class="container" id="expiryScreen" style="display:none;">
  <h1>This Month Expiry</h1>
  <div id="expiryResults"></div>

  <!-- PDF Share Button -->
  <button class="btn btn-warning" onclick="shareExpiryPDF()">üì§ Share PDF on WhatsApp</button>

  <button class="btn btn-secondary" onclick="showScreen('homeScreen')">‚¨Ö Back</button>
</div>

<!-- jsPDF Library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

<script>
  const LS_KEY = "vehicles";
  let vehicles = JSON.parse(localStorage.getItem(LS_KEY) || "[]");
  let editIndex = -1;

  function showScreen(id){
    document.querySelectorAll(".container").forEach(el => el.style.display = "none");
    document.getElementById(id).style.display = "block";
  }

  function startNew(){
    editIndex = -1;
    document.getElementById("addTitle").innerText = "Add Vehicle Detail";
    resetForm();
    showScreen('addScreen');
  }

  function resetForm(){
    ["vehicleNo","owner","ownerMobile","chassisNo","engineNo","make",
     "slipperCapacity","permitDate","insuranceDate","fitnessDate",
     "authorizationDate","homeTaxDate"].forEach(id => document.getElementById(id).value = "");
  }

  function fillForm(v){
    document.getElementById("vehicleNo").value = v.vehicleNo || "";
    document.getElementById("owner").value = v.owner || "";
    document.getElementById("ownerMobile").value = v.ownerMobile || "";
    document.getElementById("chassisNo").value = v.chassisNo || "";
    document.getElementById("engineNo").value = v.engineNo || "";
    document.getElementById("make").value = v.make || "";
    document.getElementById("slipperCapacity").value = v.slipperCapacity || "";
    document.getElementById("permitDate").value = v.permitDate || "";
    document.getElementById("insuranceDate").value = v.insuranceDate || "";
    document.getElementById("fitnessDate").value = v.fitnessDate || "";
    document.getElementById("authorizationDate").value = v.authorizationDate || "";
    document.getElementById("homeTaxDate").value = v.homeTaxDate || "";
  }

  function saveToStorage(){
    localStorage.setItem(LS_KEY, JSON.stringify(vehicles));
  }

  function saveVehicle(){
    const v = {
      vehicleNo: document.getElementById("vehicleNo").value.trim(),
      owner: document.getElementById("owner").value.trim(),
      ownerMobile: document.getElementById("ownerMobile").value.trim(),
      chassisNo: document.getElementById("chassisNo").value.trim(),
      engineNo: document.getElementById("engineNo").value.trim(),
      make: document.getElementById("make").value.trim(),
      slipperCapacity: document.getElementById("slipperCapacity").value.trim(),
      permitDate: document.getElementById("permitDate").value,
      insuranceDate: document.getElementById("insuranceDate").value,
      fitnessDate: document.getElementById("fitnessDate").value,
      authorizationDate: document.getElementById("authorizationDate").value,
      homeTaxDate: document.getElementById("homeTaxDate").value
    };

    if(!v.vehicleNo){ alert("Vehicle No required"); return; }

    if(editIndex >= 0){
      vehicles[editIndex] = v;
      alert("Vehicle Updated!");
    } else {
      vehicles.push(v);
      alert("Vehicle Saved!");
    }
    saveToStorage();
    showScreen('homeScreen');
  }

  function searchVehicle(){
    const q = document.getElementById("searchInput").value.toLowerCase();
    const results = vehicles.filter(v =>
      (v.vehicleNo||"").toLowerCase().includes(q) ||
      (v.owner||"").toLowerCase().includes(q)
    );
    displayTable(results, "searchResults", false);
  }

  function showThisMonthExpiry(){
    const now = new Date(), m = now.getMonth(), y = now.getFullYear();
    const results = vehicles.filter(v => {
      return [v.insuranceDate, v.fitnessDate, v.authorizationDate, v.homeTaxDate].some(ds=>{
        if(!ds) return false;
        const d = new Date(ds);
        return d.getMonth()===m && d.getFullYear()===y;
      });
    });
    displayTable(results, "expiryResults", true);
    showScreen('expiryScreen');
  }

  function isExpiredThisMonth(v){
    const t = new Date(), m=t.getMonth(), y=t.getFullYear();
    return [v.insuranceDate, v.fitnessDate, v.authorizationDate, v.homeTaxDate].some(ds=>{
      if(!ds) return false;
      const d = new Date(ds);
      return d.getMonth()===m && d.getFullYear()===y;
    });
  }

  function isDateThisMonth(ds){
    if(!ds) return false;
    const d = new Date(ds), t=new Date();
    return d.getMonth()===t.getMonth() && d.getFullYear()===t.getFullYear();
  }

  function displayTable(data, elId, highlight){
    let html = `<table>
      <tr>
        <th>Vehicle No</th><th>Owner</th><th>Mobile</th><th>Chassis</th><th>Engine</th>
        <th>Make</th><th>Slipper</th><th>Permit</th>
        <th>Insurance</th><th>Fitness</th><th>Authorization</th><th>Home Tax</th><th>Action</th>
      </tr>`;

    data.forEach(v=>{
      const expiredClass = highlight && isExpiredThisMonth(v) ? "expired" : "";
      const types = [];
      if(isDateThisMonth(v.insuranceDate)) types.push("Insurance");
      if(isDateThisMonth(v.fitnessDate)) types.push("Fitness");
      if(isDateThisMonth(v.authorizationDate)) types.push("Authorization");
      if(isDateThisMonth(v.homeTaxDate)) types.push("Home Tax");

      const msg = `Sir, ‡§Ü‡§™‡§ï‡•Ä ‡§¨‡§∏ ‡§®‡§Ç. ${v.vehicleNo} ‡§ï‡•Ä ${types.join(", ")} ‡§ï‡•Ä ‡§Ö‡§µ‡§ß‡§ø ‡§ñ‡§§‡•ç‡§Æ ‡§π‡•ã ‡§∞‡§π‡•Ä ‡§π‡•à‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§ß‡•ç‡§Ø‡§æ‡§® ‡§¶‡•á‡§Ç ‡§î‡§∞ ‡§π‡§Æ‡§∏‡•á ‡§∏‡§Ç‡§™‡§∞‡•ç‡§ï ‡§ï‡§∞‡•á‡§Ç‡•§`;
      const waURL = v.ownerMobile
        ? `https://wa.me/${encodeURIComponent(v.ownerMobile)}?text=${encodeURIComponent(msg)}`
        : `https://wa.me/?text=${encodeURIComponent(msg)}`;

      const idx = vehicles.indexOf(v);

      html += `<tr class="${expiredClass}"> 
        <td>${v.vehicleNo||""}</td>
        <td>${v.owner||""}</td>
        <td>${v.ownerMobile||""}</td>
        <td>${v.chassisNo||""}</td>
        <td>${v.engineNo||""}</td>
        <td>${v.make||""}</td>
        <td>${v.slipperCapacity||""}</td>
        <td>${v.permitDate||""}</td>
        <td>${v.insuranceDate||""}</td>
        <td>${v.fitnessDate||""}</td>
        <td>${v.authorizationDate||""}</td>
        <td>${v.homeTaxDate||""}</td>
        <td class="actions">
          <a class="wa" href="${waURL}" target="_blank">WhatsApp</a>
          <button class="upd" onclick="editVehicle(${idx})">Update</button>
        </td>
      </tr>`;
    });

    if(data.length===0){
      html += `<tr><td colspan="13" class="row-muted">No records found</td></tr>`;
    }

    html += `</table>`;
    document.getElementById(elId).innerHTML = html;
  }

  function editVehicle(index){
    if(index<0){ return; }
    const v = vehicles[index];
    editIndex = index;
    document.getElementById("addTitle").innerText = "Update Vehicle Detail";
    fillForm(v);
    showScreen('addScreen');
  }

  // Share PDF Function
  function shareExpiryPDF(){
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.setFontSize(16);
    doc.text("This Month Expiry List", 14, 15);

    let rows = [];
    document.querySelectorAll("#expiryResults table tr").forEach((tr, i) => {
      if(i === 0) return;
      const cells = tr.querySelectorAll("td");
      if(cells.length > 0){
        let rowData = [];
        for(let j=0; j<cells.length - 1; j++){
          rowData.push(cells[j].innerText.trim());
        }
        rows.push(rowData);
      }
    });

    const headers = [];
    document.querySelectorAll("#expiryResults table th").forEach((th, i) => {
      if(i < 12) headers.push(th.innerText);
    });

    doc.autoTable({
      head: [headers],
      body: rows,
      startY: 25,
      styles: { fontSize: 8 }
    });

    // PDF ‡§ï‡•ã Blob ‡§Æ‡•á‡§Ç ‡§¨‡§¶‡§≤‡§ï‡§∞ ‡§∂‡•á‡§Ø‡§∞ ‡§ï‡§∞‡§®‡§æ
    doc.output("blob").arrayBuffer().then(buffer => {
      const file = new File([buffer], "This_Month_Expiry.pdf", { type: "application/pdf" });
      if(navigator.share){
        navigator.share({
          title: "This Month Expiry",
          text: "Vehicle expiry list for this month.",
          files: [file]
        }).catch(err => console.log("Share cancelled", err));
      } else {
        alert("Your browser does not support direct file sharing.");
      }
    });
  }

  showScreen('homeScreen');
</script>
</body>
</html>
